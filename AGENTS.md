# å®—é—¨ä¿®çœŸå½• - Agent é¡¹ç›®è§„èŒƒ

## å…³é”®è¯´æ˜ï¼šä»…é™ä¸­æ–‡ç­–ç•¥ï¼ˆåˆ‡å‹¿åˆ é™¤æ­¤éƒ¨åˆ†ï¼‰

> **æ­¤éƒ¨åˆ†ç»ä¸å¯åˆ é™¤æˆ–ä¿®æ”¹**

### æ‰€æœ‰é¡¹ç›®äº¤æµå¿…é¡»ä½¿ç”¨ä¸­æ–‡

| ä¸Šä¸‹æ–‡ | è¯­è¨€è¦æ±‚ |
|---------|---------------------|
| **GitHub Issues** | ä»…é™ä¸­æ–‡ |
| **Pull Requests** | ä»…é™ä¸­æ–‡ï¼ˆæ ‡é¢˜ã€æè¿°ã€è¯„è®ºï¼‰ |
| **æäº¤ä¿¡æ¯** | ä»…é™ä¸­æ–‡ |
| **ä»£ç æ³¨é‡Š** | ä»…é™ä¸­æ–‡ |
| **æ–‡æ¡£** | ä»…é™ä¸­æ–‡ |
| **AGENTS.md æ–‡ä»¶** | ä»…é™ä¸­æ–‡ |

**å¦‚æœä½ ä¸ä¹ æƒ¯ç”¨ä¸­æ–‡å†™ä½œï¼Œè¯·ä½¿ç”¨ç¿»è¯‘å·¥å…·ã€‚**

---

## å…³é”®è¯´æ˜ï¼šTDDï¼ˆæµ‹è¯•é©±åŠ¨å¼€å‘ï¼‰å¼ºåˆ¶

> **æ­¤éƒ¨åˆ†ç»ä¸å¯åˆ é™¤æˆ–ä¿®æ”¹**

æœ¬é¡¹ç›®å¼ºåˆ¶ä½¿ç”¨ TDD æ¨¡å¼ã€‚æ‰€æœ‰åŠŸèƒ½å¼€å‘å¿…é¡»éµå¾ª **çº¢-ç»¿-é‡æ„** å¾ªç¯ï¼š

1. **ğŸ”´ çº¢ (Red)**: ç¼–å†™å¤±è´¥çš„æµ‹è¯• â†’ `./gradlew test` â†’ ç¡®è®¤å¤±è´¥
2. **ğŸŸ¢ ç»¿ (Green)**: ç¼–å†™æœ€å°å®ç° â†’ ç¡®è®¤é€šè¿‡
3. **ğŸ”µ é‡æ„ (Refactor)**: ä¼˜åŒ–ä»£ç ç»“æ„ â†’ ä¿æŒé€šè¿‡

**è§„åˆ™:**
- ç»ä¸åœ¨æµ‹è¯•å‰ç¼–å†™å®ç°
- ç»ä¸åˆ é™¤å¤±è´¥çš„æµ‹è¯• - å¿…é¡»ä¿®å¤ä»£ç 
- ç¦æ­¢ä¸€æ¬¡æ€§ç¼–å†™å¤§é‡ä»£ç åè¡¥æµ‹è¯•

---

## å…³é”®è¯´æ˜ï¼šä»£ç éªŒæ”¶æ ‡å‡† (DoD)

æ‰€æœ‰æäº¤å¿…é¡»æ»¡è¶³ï¼š
1. **æµ‹è¯•é€šè¿‡**: `./gradlew test` å…¨éƒ¨é€šè¿‡
2. **è¦†ç›–ç‡è¾¾æ ‡**: `./gradlew allCoverage` æ ¸å¿ƒé€»è¾‘ > 80%
3. **é™æ€æ£€æŸ¥**: æ—  Lint è­¦å‘Š
4. **æ— è„ä»£ç **: æ— ä¸´æ—¶ `println`ã€`TODO`ã€æœªä½¿ç”¨å¯¼å…¥

---

## æ¦‚è¿°

**å®—é—¨ä¿®çœŸå½• (Sect)** æ˜¯ä¸€ä¸ªåŸºäº Kotlin Multiplatform å’Œ ECS (Entity-Component-System) æ¶æ„çš„ä¿®çœŸé¢˜ææ¨¡æ‹Ÿç»è¥æ¸¸æˆã€‚
æ ¸å¿ƒç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªé«˜æ€§èƒ½ã€æ•°æ®é©±åŠ¨ã€æ˜“äºæ‰©å±•çš„æ¸¸æˆä¸–ç•Œã€‚

## ç»“æ„

```
sect/
â”œâ”€â”€ composeApp/              # åº”ç”¨ä¸»æ¨¡å— (UI/å…¥å£)
â”‚   â”œâ”€â”€ src/commonMain/      # è·¨å¹³å° UI ä»£ç 
â”‚   â”œâ”€â”€ src/androidMain/     # Android ç‰¹å®šä»£ç 
â”‚   â””â”€â”€ src/jvmMain/         # æ¡Œé¢ç‰ˆå…¥å£
â”œâ”€â”€ libs/                    # æ ¸å¿ƒåŸºç¡€åº“
â”‚   â”œâ”€â”€ lko-ecs/             # ECS æ ¸å¿ƒæ¡†æ¶ (ç»„ä»¶, å®ä½“, æŸ¥è¯¢, ç³»ç»Ÿ)
â”‚   â”œâ”€â”€ lko-core/            # åŸºç¡€å·¥å…· (FastList, BitSet, é›†åˆ)
â”‚   â”œâ”€â”€ lko-di/              # ä¾èµ–æ³¨å…¥ (ServiceLocator)
â”‚   â””â”€â”€ lko-ecs-serialization/ # ECS åºåˆ—åŒ–æ”¯æŒ
â”œâ”€â”€ business-modules/        # æ¸¸æˆä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ business-core/       # æ ¸å¿ƒå®šä¹‰ (é€šç”¨ç»„ä»¶, æ ‡ç­¾)
â”‚   â”œâ”€â”€ business-engine/     # æ¸¸æˆå¾ªç¯ä¸ä¸–ç•Œç®¡ç† (SectWorld)
â”‚   â”œâ”€â”€ business-cultivation/# ä¿®ç‚¼ç³»ç»Ÿ (å¢ƒç•Œ, çªç ´)
â”‚   â”œâ”€â”€ business-disciples/  # å¼Ÿå­ç®¡ç†
â”‚   â””â”€â”€ business-quest/      # ä»»åŠ¡ç³»ç»Ÿ
â”œâ”€â”€ benchmarks/              # æ€§èƒ½åŸºå‡†æµ‹è¯•
â”œâ”€â”€ gradle/                  # æ„å»ºé…ç½® (libs.versions.toml)
â””â”€â”€ docs/                    # é¡¹ç›®æ–‡æ¡£
```

## æ–‡æ¡£ç›®å½• (Documentation)

| ç±»åˆ« | ç›®å½•/æ–‡ä»¶ | è¯´æ˜ |
|------|-----------|------|
| **éœ€æ±‚** | `docs/requirements/æ–‡å­—æ¸¸æˆéœ€æ±‚æ–‡æ¡£_GRD.md` | æ¸¸æˆæ ¸å¿ƒéœ€æ±‚è§„æ ¼è¯´æ˜ä¹¦ |
| | `docs/design/sect_cultivation_core_gameplay.md` | ä¿®ä»™æ ¸å¿ƒç©æ³•è®¾è®¡ |
| | `docs/design/pages/` | UI/UX é¡µé¢å¸ƒå±€è®¾è®¡æ–‡æ¡£ |
| **æŠ€æœ¯** | `docs/technology/ecs-architecture.md` | ECS æ¶æ„è¯¦ç»†è®¾è®¡æ–‡æ¡£ |
| | `docs/technology/ecs/` | **ECS æ¡†æ¶ä½¿ç”¨æŒ‡å—**ï¼ˆæ¨èï¼‰ |
| | `docs/technology/å®—é—¨ä¿®çœŸå½•æ¸¸æˆå®ç°è§„èŒƒ.md` | æ¸¸æˆå…·ä½“å®ç°æŠ€æœ¯è§„èŒƒ |
| | `docs/technology/kover-coverage.md` | ä»£ç è¦†ç›–ç‡é…ç½®è¯´æ˜ |
| **è§„åˆ’/è¿ç»´** | `AGENTS.md` | **æœ¬é¡¹ç›®çŸ¥è¯†åº“ä¸ Agent æ“ä½œè§„èŒƒ (æœ¬æ–‡)** |
| | `docs/operations/CONTRIB.md` | è´¡çŒ®æŒ‡å— |
| | `docs/operations/RUNBOOK.md` | è¿ç»´ä¸è¿è¡Œæ‰‹å†Œ |

## åˆå§‹åŒ–æµç¨‹

æ¸¸æˆä¸–ç•Œçš„åˆå§‹åŒ–æµç¨‹ (å‚è€ƒ `SectWorld.kt`):

```
SectWorld.initialize()
  1. createAddon("demo")        # å®šä¹‰ç»„ä»¶å’Œæ ‡ç­¾æ³¨å†Œè¡¨
  2. world { install(addon) }   # åˆ›å»º World å¹¶å®‰è£… Addon
  3. DemoSystem(world)          # åˆå§‹åŒ–ç³»ç»Ÿ
  4. createInitialDisciples()   # åˆ›å»ºåˆå§‹å®ä½“ (Entity)
  5. update(dt)                 # å¼€å§‹æ¸¸æˆå¾ªç¯
```

## æŸ¥æ‰¾ä½ç½®

| ä»»åŠ¡ | ä½ç½® | å¤‡æ³¨ |
|------|------|------|
| **å®šä¹‰ç»„ä»¶/æ ‡ç­¾** | `business-modules/business-core/` | æ”¾ç½®åœ¨ `components/` æˆ– `tags/` åŒ…ä¸‹ |
| **å®ç°æ¸¸æˆé€»è¾‘** | `business-modules/*/systems/` | åˆ›å»º System ç±»ï¼Œå®ç° `EntityRelationContext` |
| **ä¿®æ”¹ UI** | `composeApp/src/commonMain/` | Compose Multiplatform ä»£ç  |
| **ECS æ ¸å¿ƒä¼˜åŒ–** | `libs/lko-ecs/` | ä»…é™æ¶æ„çº§ä¿®æ”¹ï¼Œéœ€æåº¦è°¨æ… |
| **æ€§èƒ½ä¼˜åŒ–** | `libs/lko-core/` | åº•å±‚æ•°æ®ç»“æ„ (FastList, Bits) |
| **ä¾èµ–ç®¡ç†** | `gradle/libs.versions.toml` | ç»Ÿä¸€ç®¡ç†ç‰ˆæœ¬å· |

## æ¨¡å—ç‰¹å®šè§„èŒƒ

### 1. `lko-ecs` (æ ¸å¿ƒæ¡†æ¶)
- **å®šä½**: ECS æ ¸å¿ƒæ¶æ„ï¼Œæ‰€æœ‰ä¸šåŠ¡çš„åŸºç¡€ã€‚
- **çº¦æŸ**:
  - ä¸¥ç¦å¼•å…¥ä»»ä½•ä¸šåŠ¡é€»è¾‘ã€‚
  - è¿½æ±‚æè‡´æ€§èƒ½ (Zero Allocation in loops)ã€‚
  - ä¸¥ç¦ä¿®æ”¹æ ¸å¿ƒæ¥å£ (`World`, `Entity`) é™¤éç»è¿‡æ¶æ„è¯„å®¡ã€‚
  - å¿…é¡»ä¿æŒ 95%+ çš„æµ‹è¯•è¦†ç›–ç‡ã€‚

### 2. `lko-core` (åŸºç¡€åº“)
- **å®šä½**: é«˜æ€§èƒ½æ•°æ®ç»“æ„ä¸å·¥å…·ã€‚
- **çº¦æŸ**:
  - æ— å¤–éƒ¨ä¾èµ– (é™¤ Kotlin stdlib)ã€‚
  - æ‰€æœ‰é›†åˆç±» (`FastList`) å¿…é¡»åŒ…å«è¾¹ç•Œæ£€æŸ¥æµ‹è¯•ã€‚
  - ä¼˜å…ˆä½¿ç”¨åŸºæœ¬ç±»å‹ç‰¹åŒ–é›†åˆ (å¦‚ `IntFastList`) é¿å…è£…ç®±ã€‚

### 3. `business-core` (ä¸šåŠ¡æ ¸å¿ƒ)
- **å®šä½**: æ¸¸æˆé€šç”¨çš„ç»„ä»¶ (`Component`) å’Œæ ‡ç­¾ (`Tag`) å®šä¹‰ã€‚
- **çº¦æŸ**:
  - ä»…åŒ…å«æ•°æ®å®šä¹‰ (`data class`, `sealed class`)ã€‚
  - ä¸¥ç¦åŒ…å«ç³»ç»Ÿé€»è¾‘ (`System`)ã€‚
  - æ‰€æœ‰æ–°ç»„ä»¶å¿…é¡»æ³¨å†Œåˆ° `createAddon` ä¸­ã€‚

### 4. `business-engine` (æ¸¸æˆå¼•æ“)
- **å®šä½**: æ¸¸æˆå¾ªç¯ã€ä¸–ç•Œåˆå§‹åŒ–ã€æ ¸å¿ƒç³»ç»Ÿ (`SectWorld`)ã€‚
- **çº¦æŸ**:
  - è´Ÿè´£ç»„è£…å…¶ä»–ä¸šåŠ¡æ¨¡å—ã€‚
  - å®ƒæ˜¯å”¯ä¸€å¯ä»¥ä¾èµ–æ‰€æœ‰å…¶ä»– `business-*` æ¨¡å—çš„åœ°æ–¹ã€‚
  - é¿å…åœ¨æ­¤å¤„ç¼–å†™å…·ä½“çš„ç©æ³•é€»è¾‘ (å¦‚æˆ˜æ–—è®¡ç®—)ï¼Œåº”å§”æ‰˜ç»™ä¸“é—¨çš„ Systemã€‚

### 5. `business-*` (å…·ä½“ç©æ³•æ¨¡å—)
- **ç¤ºä¾‹**: `business-cultivation` (ä¿®ç‚¼), `business-disciples` (å¼Ÿå­)ã€‚
- **çº¦æŸ**:
  - æ¯ä¸ªæ¨¡å—åº”è‡ªåŒ…å«å…¶ç‰¹æœ‰çš„ System å’Œè¾…åŠ© Componentã€‚
  - æ¨¡å—é—´é€šä¿¡åº”é€šè¿‡ `World` ä¸­çš„ç»„ä»¶çŠ¶æ€ï¼Œè€Œéç›´æ¥å‡½æ•°è°ƒç”¨ã€‚
  - å¿…é¡»åŒ…å«é’ˆå¯¹è¯¥ç©æ³•çš„å•å…ƒæµ‹è¯•ã€‚

## çº¦å®š

- **è¯­è¨€**: Kotlin (100%)
- **æ„å»ºç³»ç»Ÿ**: Gradle Kotlin DSL (`.gradle.kts`)
- **ECS é£æ ¼**:
    - **ç»„ä»¶**: `data class` (çº¯æ•°æ®)
    - **æ ‡ç­¾**: `sealed class` / `object` (æ— æ•°æ®æ ‡è®°)
    - **ç³»ç»Ÿ**: çº¯é€»è¾‘ï¼Œæ— çŠ¶æ€ (çŠ¶æ€å­˜ç»„ä»¶)
- **é›†åˆ**: ä¼˜å…ˆä½¿ç”¨ `lko-core` ä¸­çš„ `FastList`, `IntFastList` ç­‰é«˜æ€§èƒ½é›†åˆï¼Œè€Œé stdlib `List/ArrayList` (ECS å†…éƒ¨)ã€‚
- **æµ‹è¯•**:
    - ä½ç½®: `src/commonTest/kotlin`
    - é£æ ¼: BDD (`// Given`, `// When`, `// Then`)
    - åŠ©æ‰‹: ä½¿ç”¨ `createAddon` å¿«é€Ÿæ„å»ºæµ‹è¯• World

## åæ¨¡å¼ (Anti-Patterns)

| ç±»åˆ« | ç¦æ­¢è¡Œä¸º | æ›¿ä»£æ–¹æ¡ˆ |
|------|----------|----------|
| **ECS** | `addComponent(Tag)` / `addTag<Component>()` | ä¸¥æ ¼åŒºåˆ†ç»„ä»¶å’Œæ ‡ç­¾æ¥å£ |
| **ECS** | åœ¨ `query {}.forEach` ä¸­ä¿®æ”¹å®ä½“ç»“æ„ | æ”¶é›†å˜æ›´åç»Ÿä¸€å¤„ç†ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤é˜Ÿåˆ— |
| **Kotlin** | éšå¼ `it` å‚æ•°åµŒå¥— | æ˜¾å¼å‘½åå‚æ•° `forEach { entity -> ... }` |
| **Import** | æ··æ·† `family.component` å’Œ `relation.component` | æ£€æŸ¥å¯¼å…¥åŒ…åï¼Œç¡®è®¤ç”¨é€” |
| **Git** | æäº¤å¤±è´¥çš„æµ‹è¯• | ä¿®å¤ä»£ç æˆ–æµ‹è¯• |
| **Git** | åŒ…å« `build/`, `.idea/` ç­‰ç”Ÿæˆæ–‡ä»¶ | æ£€æŸ¥ `.gitignore` |
| **ä»£ç ** | ä½¿ç”¨ `println` è°ƒè¯• | ä½¿ç”¨æ—¥å¿—æ¡†æ¶æˆ–æµ‹è¯•æ–­è¨€ |
| **ä¾èµ–** | æ¨¡å—é—´å¾ªç¯ä¾èµ– | ä½¿ç”¨ `lko-di` æˆ–é‡æ„æ¥å£ä¸‹æ²‰ |

## ä¾èµ– (Dependencies)

| åº“ | ç”¨é€” |
|----|------|
| `lko-ecs` | è‡ªç ”é«˜æ€§èƒ½ ECS æ¡†æ¶ |
| `lko-core` | é«˜æ€§èƒ½åŸºç¡€æ•°æ®ç»“æ„ |
| `compose-multiplatform` | è·¨å¹³å° UI |
| `kotlinx-coroutines` | å¼‚æ­¥ä»»åŠ¡ |
| `kotlinx-serialization` | æ•°æ®æŒä¹…åŒ– |
| `kodein-kaverit` | è¾…åŠ©å·¥å…· |

## å‘½ä»¤

```bash
# æ„å»º
./gradlew build                         # å…¨é‡æ„å»º
./gradlew :composeApp:run               # è¿è¡Œæ¡Œé¢ç‰ˆ Demo

# æµ‹è¯•
./gradlew test                          # è¿è¡Œæ‰€æœ‰æµ‹è¯•
./gradlew :libs:lko-ecs:test            # è¿è¡Œ ECS æ ¸å¿ƒæµ‹è¯•
./gradlew :business-modules:business-engine:test # è¿è¡Œä¸šåŠ¡é€»è¾‘æµ‹è¯•

# è´¨é‡
./gradlew allCoverage                   # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
./gradlew lint                          # é™æ€ä»£ç æ£€æŸ¥
```

## å¤æ‚åº¦çƒ­ç‚¹

| æ¨¡å—/æ–‡ä»¶ | æè¿° | æ³¨æ„äº‹é¡¹ |
|-----------|------|----------|
| `libs/lko-ecs/.../World.kt` | ECS ä¸–ç•Œæ ¸å¿ƒ | æå…¶å¤æ‚ï¼Œæ¶‰åŠç»„ä»¶å­˜å‚¨ã€å®ä½“ç®¡ç†ã€ç³»ç»Ÿè°ƒåº¦ |
| `libs/lko-ecs/.../QueryStreamExtensions.kt` | æŸ¥è¯¢ DSL | å¤æ‚çš„æ³›å‹å’Œå†…è”å‡½æ•°ï¼Œä¿®æ”¹éœ€è°¨æ… |
| `libs/lko-core/.../*FastList.kt` | é«˜æ€§èƒ½é›†åˆ | æ‰‹å†™ç‰¹å®šç±»å‹é›†åˆï¼Œæ³¨æ„æ‰©å®¹é€»è¾‘å’Œæ•°ç»„è¶Šç•Œ |
| `business-modules/.../SectWorld.kt` | æ¸¸æˆå…¥å£ | è´Ÿè´£ç»„è£…å„æ¨¡å—ï¼Œæ³¨æ„åˆå§‹åŒ–é¡ºåº |

## å¤‡æ³¨

- **æ€§èƒ½ä¼˜å…ˆ**: æ ¸å¿ƒ ECS é€»è¾‘ä¸­é¿å…é¢‘ç¹å¯¹è±¡åˆ†é… (GC å‹åŠ›)ã€‚
- **æ•°æ®é©±åŠ¨**: å°½é‡å°†é€»è¾‘é€šè¿‡ç»„ä»¶æ•°æ®é…ç½®ï¼Œè€Œéç¡¬ç¼–ç ã€‚
- **KMP**: ä¿æŒä»£ç å¹³å°æ— å…³æ€§ï¼Œç‰¹å®šå¹³å°é€»è¾‘æ”¾ `androidMain`/`jvmMain`ã€‚

# 需求方案：业务模块领域隔离重构

## 基本信息
- 状态：草稿
- 优先级：P0
- 模块：所有业务模块

## 需求描述
对所有业务模块进行领域隔离重构，解决依赖混乱问题，实现高内聚、低耦合的架构。

## 问题分析

### 核心问题
1. **依赖混乱**：过度依赖，System 访问越界，直接操作其他领域数据
2. **职责不清**：类/文件职责划分不明确
3. **代码重复**：多个模块存在相似代码
4. **难以测试**：测试用例难以编写

### 问题影响
- 修改一处代码影响多处，难以维护
- 新功能开发困难，需要处理大量依赖
- 测试覆盖困难，Mock 成本高
- 代码可读性差，理解成本高

## 解决方案

### 领域隔离策略
按业务模块划分领域边界，每个 System 只操作自己领域的组件。

### 领域划分
| 领域 | 模块 | 核心职责 |
|------|------|----------|
| 修炼 | business-cultivation | 修炼进度、境界突破 |
| 弟子 | business-disciples | 弟子管理、状态追踪 |
| 战斗 | business-combat | 战斗逻辑、伤害计算 |
| 功法 | business-skill | 功法学习、技能释放 |

### 跨模块通信
使用 ECS 框架内的观察者服务进行跨模块通信，实现发布/订阅模式。

## 实施步骤

### Phase 1: 调研与准备
- [ ] 调研 ECS 框架的观察者服务能力
- [ ] 确定观察者服务的使用方式
- [ ] 制定每个模块的职责边界文档

### Phase 2: 试点重构
- [ ] 选择一个模块进行试点重构
- [ ] 验证领域隔离方案可行性
- [ ] 总结经验教训

### Phase 3: 全面重构
- [ ] 按模块逐个进行重构
- [ ] 编写测试用例保证质量
- [ ] 代码审查

### Phase 4: 验证与优化
- [ ] 运行全量测试
- [ ] 性能测试
- [ ] 文档更新

## 验收标准
- [ ] 每个 System 只操作自己领域的组件
- [ ] 跨模块通信通过观察者服务实现
- [ ] 测试覆盖率 > 80%
- [ ] 无循环依赖
- [ ] 代码通过静态检查

## 风险与缓解
| 风险 | 缓解措施 |
|------|----------|
| 重构范围大，可能引入 Bug | 分阶段进行，每阶段完整测试 |
| 观察者服务能力不足 | 提前调研，必要时扩展框架 |
| 影响开发进度 | 选择低峰期进行 |

## 待确认
- [ ] 观察者服务的具体能力是否满足需求？
- [ ] 试点模块选择哪个？

## 关联记忆
- #conventions:ECS架构
- #conventions:Kotlin开发规范

# 第一阶段实现计划：角色与宗门基础架构

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** 实现宗门修真录的基础架构，包括角色组件定义、宗门组件、设施定义、简单AI行为系统

**Architecture:** 基于 ECS 框架，使用组件化设计。组件定义在 business-core，业务逻辑在对应垂直模块，初始化在 business-engine

**Tech Stack:** Kotlin Multiplatform, ECS (lko-ecs), TDD

---

## 任务概览

| 任务 | 描述 | 依赖 |
|------|------|------|
| 1 | 定义境界枚举和修炼组件 | 无 |
| 2 | 定义角色属性组件 | 无 |
| 3 | 定义职务枚举和组件 | 无 |
| 4 | 定义宗门组件 | 无 |
| 5 | 定义设施组件 | 无 |
| 6 | 定义行为状态组件 | 无 |
| 7 | 实现 SectWorld 初始化 | 任务1-6 |
| 8 | 实现简单AI行为系统 | 任务6 |

---

## Task 1: 定义境界枚举和修炼组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/cultivation/Realm.kt`
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/cultivation/CultivationComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/cultivation/CultivationComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/cultivation/CultivationComponentTest.kt
package cn.jzl.sect.core.cultivation

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.query.EntityQueryContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class CultivationComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<CultivationComponent>()
            world.componentId<Realm> { it.tag() }
        }
    }

    @BeforeTest
    fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testRealmEnumValues() {
        assertEquals(Realm.MORTAL, Realm.valueOf("MORTAL"))
        assertEquals(Realm.QI_REFINING, Realm.valueOf("QI_REFINING"))
        assertEquals(Realm.FOUNDATION, Realm.valueOf("FOUNDATION"))
    }

    @Test
    fun testCultivationComponentCreation() {
        val entity = world.entity {
            it.addComponent(CultivationComponent(
                realm = Realm.QI_REFINING,
                layer = 5,
                cultivation = 5000L,
                maxCultivation = 10000L
            ))
        }

        val cultivation = entity.getComponent<CultivationComponent>()
        assertEquals(Realm.QI_REFINING, cultivation.realm)
        assertEquals(5, cultivation.layer)
        assertEquals(5000L, cultivation.cultivation)
        assertEquals(10000L, cultivation.maxCultivation)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.cultivation.CultivationComponentTest" -v`
Expected: FAIL - file not found

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/cultivation/Realm.kt
package cn.jzl.sect.core.cultivation

enum class Realm {
    MORTAL,       // 凡人而未入门
    QI_REFINING,  // 炼气期
    FOUNDATION,   // 筑基期
}

// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/cultivation/CultivationComponent.kt
package cn.jzl.sect.core.cultivation

data class CultivationComponent(
    val realm: Realm = Realm.MORTAL,
    val layer: Int = 1,
    val cultivation: Long = 0L,
    val maxCultivation: Long = 1000L
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.cultivation.CultivationComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/cultivation/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/cultivation/
git commit -m "feat: 添加境界枚举和修炼组件定义"
```

---

## Task 2: 定义角色属性组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/disciple/AttributeComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/disciple/AttributeComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/disciple/AttributeComponentTest.kt
package cn.jzl.sect.core.disciple

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class AttributeComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<AttributeComponent>()
        }
    }

    @BeforeTest
    fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testAttributeComponentCreation() {
        val entity = world.entity {
            it.addComponent(AttributeComponent(
                physique = 50,
                comprehension = 60,
                fortune = 40,
                charm = 45,
                strength = 30,
                agility = 35,
                intelligence = 40,
                endurance = 25,
                health = 100,
                maxHealth = 100,
                spirit = 50,
                maxSpirit = 50,
                age = 20
            ))
        }

        val attr = entity.getComponent<AttributeComponent>()
        assertEquals(50, attr.physique)
        assertEquals(60, attr.comprehension)
        assertEquals(20, attr.age)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.disciple.AttributeComponentTest" -v`
Expected: FAIL - file not found

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/disciple/AttributeComponent.kt
package cn.jzl.sect.core.disciple

data class AttributeComponent(
    // 基础资质
    val physique: Int = 50,       // 根骨 1-100
    val comprehension: Int = 50,  // 悟性 1-100
    val fortune: Int = 50,         // 福缘 1-100
    val charm: Int = 50,           // 魅力 1-100
    
    // 四维属性
    val strength: Int = 20,       // 力量
    val agility: Int = 20,        // 敏捷
    val intelligence: Int = 20,   // 智力
    val endurance: Int = 20,      // 耐力
    
    // 状态
    val health: Int = 100,         // 生命值
    val maxHealth: Int = 100,     // 最大生命值
    val spirit: Int = 50,         // 灵气值
    val maxSpirit: Int = 50,      // 最大灵气值
    val age: Int = 18             // 年龄
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.disciple.AttributeComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/disciple/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/disciple/
git commit -m "feat: 添加角色属性组件定义"
```

---

## Task 3: 定义职务枚举和组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/Position.kt`
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/PositionComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/PositionComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/PositionComponentTest.kt
package cn.jzl.sect.core.sect

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class PositionComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<PositionComponent>()
        }
    }

    @BeforeTest
    fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testPositionEnumValues() {
        assertEquals(Position.LEADER, Position.valueOf("LEADER"))
        assertEquals(Position.ELDER, Position.valueOf("ELDER"))
        assertEquals(Position.DISCIPLE_CORE, Position.valueOf("DISCIPLE_CORE"))
    }

    @Test
    fun testPositionComponentCreation() {
        val entity = world.entity {
            it.addComponent(PositionComponent(position = Position.DISCIPLE_OUTER))
        }

        val pos = entity.getComponent<PositionComponent>()
        assertEquals(Position.DISCIPLE_OUTER, pos.position)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.sect.PositionComponentTest" -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/Position.kt
package cn.jzl.sect.core.sect

enum class Position {
    DISCIPLE_OUTER,   // 外门弟子
    DISCIPLE_INNER,   // 内门弟子
    DISCIPLE_CORE,    // 亲传弟子
    ELDER,            // 长老
    LEADER,           // 掌门
}

// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/PositionComponent.kt
package cn.jzl.sect.core.sect

data class PositionComponent(
    val position: Position = Position.DISCIPLE_OUTER,
    val department: String? = null  // 所属部门
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.sect.PositionComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/
git commit -m "feat: 添加职务枚举和组件定义"
```

---

## Task 4: 定义宗门组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/SectComponent.kt`
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/SectResourceComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/SectComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/SectComponentTest.kt
package cn.jzl.sect.core.sect

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class SectComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<SectComponent>()
            world.componentId<SectResourceComponent>()
        }
BeforeTest
       }

    @ fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testSectComponentCreation() {
        val entity = world.entity {
            it.addComponent(SectComponent(
                name = "青云宗",
                leaderId = 1,
                foundedYear = 1
            ))
        }

        val sect = entity.getComponent<SectComponent>()
        assertEquals("青云宗", sect.name)
        assertEquals(1, sect.leaderId)
    }

    @Test
    fun testResourceComponent() {
        val entity = world.entity {
            it.addComponent(SectResourceComponent(
                spiritStones = 1000L,
                contributionPoints = 500L
            ))
        }

        val resource = entity.getComponent<SectResourceComponent>()
        assertEquals(1000L, resource.spiritStones)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.sect.SectComponentTest" -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/SectComponent.kt
package cn.jzl.sect.core.sect

data class SectComponent(
    val name: String,
    val leaderId: Long,
    val foundedYear: Int
)

// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/SectResourceComponent.kt
package cn.jzl.sect.core.sect

data class SectResourceComponent(
    val spiritStones: Long = 1000L,
    val contributionPoints: Long = 0L
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.sect.SectComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/sect/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/sect/
git commit -m "feat: 添加宗门组件和资源组件定义"
```

---

## Task 5: 定义设施组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/facility/FacilityType.kt`
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/facility/FacilityComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/facility/FacilityComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/facility/FacilityComponentTest.kt
package cn.jzl.sect.core.facility

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class FacilityComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<FacilityComponent>()
        }
    }

    @BeforeTest
    fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testFacilityTypeValues() {
        assertEquals(FacilityType.CULTIVATION_ROOM, FacilityType.CULTIVATION_ROOM)
    }

    @Test
    fun testFacilityComponentCreation() {
        val entity = world.entity {
            it.addComponent(FacilityComponent(
                type = FacilityType.CULTIVATION_ROOM,
                level = 1,
                capacity = 5,
                efficiency = 1.1f
            ))
        }

        val facility = entity.getComponent<FacilityComponent>()
        assertEquals(FacilityType.CULTIVATION_ROOM, facility.type)
        assertEquals(1, facility.level)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.facility.FacilityComponentTest" -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/facility/FacilityType.kt
package cn.jzl.sect.core.facility

enum class FacilityType {
    CULTIVATION_ROOM,  // 修炼室
    ALCHEMY_ROOM,      // 炼丹房
    FORGE_ROOM,        // 炼器坊
    LIBRARY,           // 藏经阁
    WAREHOUSE,         // 仓库
    DORMITORY,         // 弟子房
}

// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/facility/FacilityComponent.kt
package cn.jzl.sect.core.facility

data class FacilityComponent(
    val type: FacilityType,
    val level: Int = 1,
    val capacity: Int = 0,
    val efficiency: Float = 1.0f
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.facility.FacilityComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/facility/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/facility/
git commit -m "feat: 添加设施类型和组件定义"
```

---

## Task 6: 定义行为状态组件

**Files:**
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/ai/BehaviorType.kt`
- Create: `business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/ai/BehaviorStateComponent.kt`
- Test: `business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/ai/BehaviorStateComponentTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/ai/BehaviorStateComponentTest.kt
package cn.jzl.sect.core.ai

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.component.componentId
import kotlin.test.*

class BehaviorStateComponentTest : EntityRelationContext {
    override lateinit var world: World

    private val testAddon = createAddon<Unit>("test") {
        components {
            world.componentId<BehaviorStateComponent>()
        }
    }

    @BeforeTest
    fun setup() {
        world = world { install(testAddon) }
    }

    @Test
    fun testBehaviorTypeEnum() {
        assertEquals(BehaviorType.CULTIVATE, BehaviorType.CULTIVATE)
    }

    @Test
    fun testBehaviorStateComponentCreation() {
        val entity = world.entity {
            it.addComponent(BehaviorStateComponent(
                currentBehavior = BehaviorType.CULTIVATE
            ))
        }

        val behavior = entity.getComponent<BehaviorStateComponent>()
        assertEquals(BehaviorType.CULTIVATE, behavior.currentBehavior)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.ai.BehaviorStateComponentTest" -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/ai/BehaviorType.kt
package cn.jzl.sect.core.ai

enum class BehaviorType {
    CULTIVATE,  // 修炼
    WORK,       // 工作
    REST,       // 休息
    SOCIAL,     // 社交
}

// business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/ai/BehaviorStateComponent.kt
package cn.jzl.sect.core.ai

data class BehaviorStateComponent(
    val currentBehavior: BehaviorType = BehaviorType.CULTIVATE,
    val behaviorStartTime: Long = 0L,
    val lastBehaviorTime: Long = 0L
)
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-core:test --tests "cn.jzl.sect.core.ai.BehaviorStateComponentTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-core/src/commonMain/kotlin/cn/jzl/sect/core/ai/
git add business-modules/business-core/src/commonTest/kotlin/cn/jzl/sect/core/ai/
git commit -m "feat: 添加行为类型和状态组件定义"
```

---

## Task 7: 实现 SectWorld 初始化

**Files:**
- Create: `business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/SectWorld.kt`
- Create: `business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/SectAddon.kt`
- Test: `business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/SectWorldTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/SectWorldTest.kt
package cn.jzl.sect.engine

import cn.jzl.ecs.addon.createAddon
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.family.component
import cn.jzl.sect.core.cultivation.*
import cn.jzl.sect.core.disciple.AttributeComponent
import cn.jzl.sect.core.sect.*
import cn.jzl.sect.core.facility.*
import kotlin.test.*

class SectWorldTest : EntityRelationContext {
    override lateinit var world: World

    @BeforeTest
    fun setup() {
        world = SectWorld.create("青云宗")
    }

    @Test
    fun testSectCreation() {
        val sectQuery = world.query { component<SectComponent>() }
        assertEquals(1, sectQuery.size, "Should have one sect entity")
    }

    @Test
    fun testInitialDisciples() {
        val discipleQuery = world.query { component<PositionComponent>() }
        assertTrue(discipleQuery.size >= 5, "Should have at least 5 initial disciples")
    }

    @Test
    fun testLeaderExists() {
        val leaderQuery = world.query { 
            component<PositionComponent> { PositionComponent(it.position == Position.LEADER) }
        }
        assertEquals(1, leaderQuery.size, "Should have one leader")
    }

    @Test
    fun testInitialResources() {
        val resourceQuery = world.query { component<SectResourceComponent>() }
        assertEquals(1, resourceQuery.size, "Should have resource component")
        val resource = resourceQuery.first().getComponent<SectResourceComponent>()
        assertEquals(1000L, resource.spiritStones)
    }

    @Test
    fun testInitialFacilities() {
        val facilityQuery = world.query { component<FacilityComponent>() }
        assertTrue(facilityQuery.size >= 1, "Should have at least 1 facility")
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-engine:test --tests "cn.jzl.sect.engine.SectWorldTest" -v`
Expected: FAIL - file not found

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/SectAddon.kt
package cn.jzl.sect.engine

import cn.jzl.ecs.addon.components
import cn.jzl.ecs.addon.createAddon

object SectAddon {
    val addon = createAddon<Unit>("sect") {
        components {
            // 修炼系统
            cn.jzl.ecs.component.componentId<CultivationComponent>()
            cn.jzl.ecs.component.componentId<Realm> { it.tag() }
            
            // 弟子系统
            cn.jzl.ecs.component.componentId<AttributeComponent>()
            cn.jzl.ecs.component.componentId<PositionComponent>()
            
            // 宗门系统
            cn.jzl.ecs.component.componentId<SectComponent>()
            cn.jzl.ecs.component.componentId<SectResourceComponent>()
            
            // 设施系统
            cn.jzl.ecs.component.componentId<FacilityComponent>()
            
            // AI行为系统
            cn.jzl.ecs.component.componentId<BehaviorStateComponent>()
        }
    }
}

// business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/SectWorld.kt
package cn.jzl.sect.engine

import cn.jzl.ecs.World
import cn.jzl.ecs.addon.install
import cn.jzl.ecs.addon.world
import cn.jzl.sect.core.ai.*
import cn.jzl.sect.core.cultivation.*
import cn.jzl.sect.core.disciple.AttributeComponent
import cn.jzl.sect.core.facility.*
import cn.jzl.sect.core.sect.*

object SectWorld {
    fun create(sectName: String): World {
        return world {
            install(SectAddon.addon)
            createSect(sectName)
            createInitialDisciples()
            createInitialFacilities()
        }
    }

    private fun World.createSect(name: String) {
        entity {
            it.addComponent(SectComponent(
                name = name,
                leaderId = 0,
                foundedYear = 1
            ))
            it.addComponent(SectResourceComponent(
                spiritStones = 1000L,
                contributionPoints = 0L
            ))
        }
    }

    private fun World.createInitialDisciples() {
        // 创建掌门 (筑基期5层)
        entity {
            it.addComponent(CultivationComponent(
                realm = Realm.FOUNDATION,
                layer = 5,
                cultivation = 5000L,
                maxCultivation = 10000L
            ))
            it.addComponent(AttributeComponent(
                physique = 70,
                comprehension = 65,
                fortune = 50,
                charm = 60,
                age = 80
            ))
            it.addComponent(PositionComponent(position = Position.LEADER))
            it.addComponent(BehaviorStateComponent(currentBehavior = BehaviorType.CULTIVATE))
        }

        // 创建2名长老 (筑基期3层)
        repeat(2) { i ->
            entity {
                it.addComponent(CultivationComponent(
                    realm = Realm.FOUNDATION,
                    layer = 3,
                    cultivation = 3000L,
                    maxCultivation = 10000L
                ))
                it.addComponent(AttributeComponent(
                    physique = 55 + i * 5,
                    comprehension = 50 + i * 5,
                    age = 60 + i * 5
                ))
                it.addComponent(PositionComponent(position = Position.ELDER))
                it.addComponent(BehaviorStateComponent(currentBehavior = BehaviorType.CULTIVATE))
            }
        }

        // 创建5名外门弟子 (炼气期3-5层)
        repeat(5) { i ->
            entity {
                val layer = 3 + (i % 3)
                it.addComponent(CultivationComponent(
                    realm = Realm.QI_REFINING,
                    layer = layer,
                    cultivation = layer * 1000L,
                    maxCultivation = 5000L
                ))
                it.addComponent(AttributeComponent(
                    physique = 30 + i * 5,
                    comprehension = 30 + i * 5,
                    age = 18 + i
                ))
                it.addComponent(PositionComponent(position = Position.DISCIPLE_OUTER))
                it.addComponent(BehaviorStateComponent(currentBehavior = BehaviorType.CULTIVATE))
            }
        }
    }

    private fun World.createInitialFacilities() {
        // 创建修炼室
        entity {
            it.addComponent(FacilityComponent(
                type = FacilityType.CULTIVATION_ROOM,
                level = 1,
                capacity = 5,
                efficiency = 1.1f
            ))
        }

        // 创建弟子房
        entity {
            it.addComponent(FacilityComponent(
                type = FacilityType.DORMITORY,
                level = 1,
                capacity = 20,
                efficiency = 1.0f
            ))
        }
    }
}
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-engine:test --tests "cn.jzl.sect.engine.SectWorldTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/
git add business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/
git commit -m "feat: 添加宗门世界初始化实现"
```

---

## Task 8: 实现简单AI行为系统

**Files:**
- Create: `business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/systems/SimpleBehaviorSystem.kt`
- Test: `business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/systems/SimpleBehaviorSystemTest.kt`

**Step 1: Write the failing test**

```kotlin
// business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/systems/SimpleBehaviorSystemTest.kt
package cn.jzl.sect.engine.systems

import cn.jzl.sect.core.ai.*
import cn.jzl.sect.core.cultivation.*
import cn.jzl.sect.core.disciple.AttributeComponent
import cn.jzl.sect.engine.SectWorld
import cn.jzl.ecs.entity.EntityRelationContext
import cn.jzl.ecs.family.component
import kotlin.test.*

class SimpleBehaviorSystemTest : EntityRelationContext {
    override lateinit var world: World

    @BeforeTest
    fun setup() {
        world = SectWorld.create("测试宗门")
    }

    @Test
    fun testBehaviorSystemExecution() {
        val system = SimpleBehaviorSystem(world)
        
        val discipleQuery = world.query { 
            component<BehaviorStateComponent>() 
        }
        val initialCount = discipleQuery.size
        
        system.update(1.0f)
        
        // 验证系统执行后没有错误
        assertTrue(true)
    }

    @Test
    fun testCultivationBehavior() {
        // 获取一个弟子实体并确保有灵气
        val discipleQuery = world.query { 
            component<BehaviorStateComponent>()
            component<CultivationComponent>()
        }
        
        val entity = discipleQuery.first()
        
        // 更新行为系统
        val system = SimpleBehaviorSystem(world)
        system.update(1.0f)
        
        // 验证行为可以正常执行
        val behavior = entity.getComponent<BehaviorStateComponent>()
        assertNotNull(behavior)
    }
}
```

**Step 2: Run test to verify it fails**

Run: `./gradlew :business-modules:business-engine:test --tests "cn.jzl.sect.engine.systems.SimpleBehaviorSystemTest" -v`
Expected: FAIL

**Step 3: Write minimal implementation**

```kotlin
// business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/systems/SimpleBehaviorSystem.kt
package cn.jzl.sect.engine.systems

import cn.jzl.ecs.World
import cn.jzl.ecs.query.EntityQueryContext
import cn.jzl.sect.core.ai.*
import cn.jzl.sect.core.cultivation.*
import cn.jzl.sect.core.disciple.AttributeComponent

class SimpleBehaviorSystem(private val world: World) : EntityQueryContext(world) {
    
    fun update(dt: Float) {
        val disciples = world.familyService.family {
            component<BehaviorStateComponent>()
            component<CultivationComponent>()
            component<AttributeComponent>()
        }
        
        disciples.forEach { entity ->
            val behavior = entity.getComponent<BehaviorStateComponent>()
            val cultivation = entity.getComponent<CultivationComponent>()
            val attr = entity.getComponent<AttributeComponent>()
            
            // 简单决策逻辑：
            // 1. 灵气 >= 30% → 修炼
            // 2. 健康 < 30% → 休息
            // 3. 否则 → 工作
            
            val spiritRatio = attr.spirit.toFloat() / attr.maxSpirit
            
            val newBehavior = when {
                spiritRatio >= 0.3f -> BehaviorType.CULTIVATE
                attr.health < attr.maxHealth * 0.3f -> BehaviorType.REST
                else -> BehaviorType.WORK
            }
            
            // 执行行为
            executeBehavior(entity, newBehavior, dt)
        }
    }
    
    private fun executeBehavior(entity: cn.jzl.ecs.entity.Entity, behavior: BehaviorType, dt: Float) {
        when (behavior) {
            BehaviorType.CULTIVATE -> {
                val attr = entity.getComponent<AttributeComponent>()
                val cultivation = entity.getComponent<CultivationComponent>()
                
                // 修炼消耗灵气，增加修为
                val spiritCost = (10 * dt).toInt()
                val cultivationGain = (attr.physique * dt * 0.1).toLong()
                
                val newSpirit = maxOf(0, attr.spirit - spiritCost)
                val newCultivation = minOf(
                    cultivation.cultivation + cultivationGain,
                    cultivation.maxCultivation
                )
                
                entity.editor {
                    it.addComponent(AttributeComponent(
                        physique = attr.physique,
                        comprehension = attr.comprehension,
                        fortune = attr.fortune,
                        charm = attr.charm,
                        strength = attr.strength,
                        agility = attr.agility,
                        intelligence = attr.intelligence,
                        endurance = attr.endurance,
                        health = attr.health,
                        maxHealth = attr.maxHealth,
                        spirit = newSpirit,
                        maxSpirit = attr.maxSpirit,
                        age = attr.age
                    ))
                    it.addComponent(CultivationComponent(
                        realm = cultivation.realm,
                        layer = cultivation.layer,
                        cultivation = newCultivation,
                        maxCultivation = cultivation.maxCultivation
                    ))
                }
            }
            
            BehaviorType.REST -> {
                val attr = entity.getComponent<AttributeComponent>()
                
                // 休息恢复灵气
                val spiritRecover = (5 * dt).toInt()
                val newSpirit = minOf(attr.spirit + spiritRecover, attr.maxSpirit)
                
                entity.editor {
                    it.addComponent(AttributeComponent(
                        physique = attr.physique,
                        comprehension = attr.comprehension,
                        fortune = attr.fortune,
                        charm = attr.charm,
                        strength = attr.strength,
                        agility = attr.agility,
                        intelligence = attr.intelligence,
                        endurance = attr.endurance,
                        health = attr.health,
                        maxHealth = attr.maxHealth,
                        spirit = newSpirit,
                        maxSpirit = attr.maxSpirit,
                        age = attr.age
                    ))
                }
            }
            
            BehaviorType.WORK -> {
                val attr = entity.getComponent<AttributeComponent>()
                
                // 工作恢复少量灵气和生命
                val spiritRecover = (2 * dt).toInt()
                val healthRecover = (1 * dt).toInt()
                
                val newSpirit = minOf(attr.spirit + spiritRecover, attr.maxSpirit)
                val newHealth = minOf(attr.health + healthRecover, attr.maxHealth)
                
                entity.editor {
                    it.addComponent(AttributeComponent(
                        physique = attr.physique,
                        comprehension = attr.comprehension,
                        fortune = attr.fortune,
                        charm = attr.charm,
                        strength = attr.strength,
                        agility = attr.agility,
                        intelligence = attr.intelligence,
                        endurance = attr.endurance,
                        health = newHealth,
                        maxHealth = attr.maxHealth,
                        spirit = newSpirit,
                        maxSpirit = attr.maxSpirit,
                        age = attr.age
                    ))
                }
            }
            
            BehaviorType.SOCIAL -> {
                // 第一阶段暂不实现社交行为
            }
        }
    }
}
```

**Step 4: Run test to verify it passes**

Run: `./gradlew :business-modules:business-engine:test --tests "cn.jzl.sect.engine.systems.SimpleBehaviorSystemTest" -v`
Expected: PASS

**Step 5: Commit**

```bash
git add business-modules/business-engine/src/commonMain/kotlin/cn/jzl/sect/engine/systems/
git add business-modules/business-engine/src/commonTest/kotlin/cn/jzl/sect/engine/systems/
git commit -m "feat: 添加简单AI行为系统实现"
```

---

## 计划完成

计划已保存至 `docs/plans/2026-02-17-phase1-design.md` 和 `docs/plans/2026-02-17-phase1-plan.md`

**两种执行方式：**

**1. Subagent-Driven (本会话)** - 我为每个任务派遣子代理，任务间进行代码审查，快速迭代

**2. Parallel Session (新会话)** - 在新会话中打开 executing-plans，批量执行带检查点

你想用哪种方式？
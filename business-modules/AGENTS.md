# business-modules - 游戏业务逻辑目录

## 目录定位
存放游戏的具体业务逻辑实现，基于 ECS 框架构建游戏玩法系统。

## 架构分层

```
┌─────────────────────────────────────────────────────────┐
│  business-engine        │  引擎与调度（应用层）          │
├─────────────────────────┼───────────────────────────────┤
│  business-quest         │  任务系统（垂直业务域）        │
│  business-cultivation   │  修炼系统（垂直业务域）        │
│  business-disciples     │  弟子系统（垂直业务域）        │
│  business-ai-goap       │  AI 决策系统（垂直业务域）     │
├─────────────────────────┼───────────────────────────────┤
│  business-core          │  领域核心抽象（共享内核）      │
└─────────────────────────┴───────────────────────────────┘
```

## 模块职责与区分

### 共享内核层

| 模块 | 职责 | 被依赖方 | 设计原则 |
|------|------|----------|----------|
| **business-core** | 通用组件、标签、基础服务 | 所有业务模块 | 高复用性，纯数据定义 |

### 垂直业务域层

| 模块 | 职责 | 依赖 | 核心概念 |
|------|------|------|----------|
| **business-ai-goap** | AI 决策与行为规划 | business-core | Planner, Action, WorldState |
| **business-cultivation** | 修炼进度、境界管理 | business-core | Cultivation, Realm, Breakthrough |
| **business-disciples** | 弟子管理、属性成长 | business-core, business-cultivation | Disciple, Attribute, Growth |
| **business-quest** | 任务系统、剧情推进 | business-core | Quest, Objective, Reward |

### 应用层

| 模块 | 职责 | 依赖 | 设计原则 |
|------|------|------|----------|
| **business-engine** | 世界初始化、主循环、模块组装 | 所有其他模块 | 调度规范，协调各系统 |

## 模块间通信规范

```
┌─────────────────────────────────────────────────────────┐
│                    business-engine                       │
│              (协调者，负责初始化和调度)                    │
└─────────────────────┬───────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
┌──────────────┐ ┌─────────┐ ┌──────────────┐
│ business-quest│ │business-│ │business-     │
│              │ │cultivate│ │disciples     │
└──────────────┘ └─────────┘ └──────────────┘
        ▲             ▲             ▲
        └─────────────┼─────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
┌──────────────┐ ┌─────────┐ ┌──────────────┐
│ business-    │ │business-│ │ business-    │
│ ai-goap      │ │ core    │ │ (others)     │
└──────────────┘ └─────────┘ └──────────────┘
```

**通信规则**:
1. 垂直业务域之间**禁止直接调用**，通过 World 的组件状态通信
2. business-engine 可依赖所有模块，其他模块**禁止依赖** business-engine
3. business-core 被所有模块依赖，**禁止依赖**任何其他业务模块

## 子模块索引

### 共享内核层
- [business-core](./business-core/AGENTS.md): 领域核心抽象，通用组件和标签定义

### 垂直业务域层
- [business-ai-goap](./business-ai-goap/AGENTS.md): AI 决策系统，GOAP 规划器
- [business-common](./business-common/AGENTS.md): 公共模块，时间和倒计时服务
- [business-cultivation](./business-cultivation/AGENTS.md): 修炼系统，境界和修为管理
- [business-disciples](./business-disciples/AGENTS.md): 弟子系统，关系和师徒管理
- [business-resource](./business-resource/AGENTS.md): 资源系统，生产和消耗管理
- [business-facility](./business-facility/AGENTS.md): 设施系统，宗门状态和价值评估
- [business-building](./business-building/AGENTS.md): 建筑系统，建造和升级管理
- [business-skill](./business-skill/AGENTS.md): 功法系统，学习和传承管理
- [business-combat](./business-combat/AGENTS.md): 战斗系统，战斗逻辑和结算
- [business-quest](./business-quest/AGENTS.md): 任务系统，任务执行和团队组建

### 应用层
- [business-engine](./business-engine/AGENTS.md): 游戏引擎，世界初始化和系统协调

## 分模块强制规则

### 何时需要拆分模块

#### 业务域独立性判断
当新增业务功能满足以下条件时，应考虑拆分为独立模块：
1. **独立的业务域**：功能属于独立的业务领域，有明确的边界
2. **独立的数据模型**：有独立的组件和实体定义
3. **独立的业务规则**：有独立的业务逻辑和规则
4. **独立的演进路径**：功能会独立演进，版本节奏与其他模块不同

#### 拆分决策检查清单
- [ ] 该功能是否属于独立的业务域？
- [ ] 该功能是否有独立的组件和实体定义？
- [ ] 该功能是否有独立的业务规则？
- [ ] 该功能是否会独立演进和版本化？
- [ ] 拆分后是否会增加不必要的复杂性？

**决策原则**：如果上述检查清单中有 3 个或以上为"是"，则应拆分为独立模块。

### 模块分层原则

#### 分层依赖规则
```
┌─────────────────────────────────────────────────────────┐
│  应用层          →  可依赖所有垂直业务域和共享内核        │
├─────────────────────────────────────────────────────────┤
│  垂直业务域层    →  可依赖共享内核层                     │
├─────────────────────────────────────────────────────────┤
│  共享内核层      →  可依赖 libs 模块                     │
└─────────────────────────────────────────────────────────┘
```

**强制规则**：
- 上层模块可依赖下层模块
- 禁止反向依赖（下层模块不得依赖上层模块）
- 垂直业务域之间禁止相互依赖
- 所有业务模块必须依赖 business-core

#### 模块粒度控制

**过粗的模块特征**（需要拆分）：
- 单个模块包含多个不相关的业务域
- 模块组件数量过多，职责不清晰
- 模块变更频率高，影响范围大
- 模块代码量大，难以维护

**过细的模块特征**（需要合并）：
- 模块之间频繁交互，耦合度高
- 模块职责过于单一，缺乏独立性
- 模块依赖关系过于复杂
- 增加了不必要的复杂性

### 模块命名规范

#### 命名格式
- **共享内核**：`business-core`
- **垂直业务域**：`business-{业务域名称}`（如 business-quest, business-cultivation）
- **应用层**：`business-engine`

#### 命名原则
1. **业务导向**：名称应清晰表达业务领域
2. **避免技术术语**：使用业务术语而非技术术语
3. **层次体现**：名称应体现模块所在层次
4. **一致性**：同类模块应使用一致的命名风格

### 模块间通信规范

#### 通信方式
- **推荐方式**：通过 World 的组件状态通信
- **禁止方式**：模块间直接调用方法或访问状态

#### 通信规则
1. 垂直业务域之间**禁止直接调用**
2. business-engine 可依赖所有模块，其他模块**禁止依赖** business-engine
3. business-core 被所有模块依赖，**禁止依赖**任何其他业务模块

### Code Review 检查要点

#### 模块拆分合理性检查
- [ ] 新模块是否有明确的业务域边界？
- [ ] 新模块的依赖关系是否合理？
- [ ] 新模块的粒度是否适当？
- [ ] 新模块的命名是否规范？

#### 分层依赖检查
- [ ] 是否遵循分层依赖原则？
- [ ] 是否存在反向依赖？
- [ ] 垂直业务域之间是否相互依赖？
- [ ] 所有业务模块是否都依赖 business-core？

#### 模块边界检查
- [ ] 模块职责是否清晰？
- [ ] 模块之间是否通过 World 状态通信？
- [ ] 模块内部实现是否对外隐藏？
- [ ] 模块变更是否影响其他模块？

## AI 开发指引

### 创建新模块

1. 确定模块所属层级（共享内核/垂直业务域/应用层）
2. 在模块根目录创建 `AGENTS.md` 描述职责
3. 遵循 TDD: 测试 → 实现 → 重构
4. 核心逻辑覆盖率必须 > 80%

### 模块开发原则

- **单一职责**: 每个模块只负责一个明确的业务领域
- **组件原子化**: 避免大组件，遵循 ECS 原子化设计原则
- **无直接调用**: 模块间通过 World 状态通信，不直接调用
- **文档同步**: 新增组件必须更新 AGENTS.md 和代码地图
- **模块拆分**: 新增模块必须遵循分模块强制规则

### 依赖管理

```kotlin
// ✅ 正确：只依赖下层模块
implementation(projects.businessModules.businessCore)

// ❌ 错误：禁止依赖同层或上层模块
implementation(projects.businessModules.businessEngine)
```
